<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>逐字背景亮度偵測</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #111; overflow-x: hidden; }
        
        #bg-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            /* 預設一張線上圖片方便你直接測試，也可以換回你的 wb-background1.jpg */
            background-image: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=1600');
            background-size: cover;
            background-position: center;
            z-index: -1;
        }

        .content {
            padding: 100px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 50px;
        }

        .adaptive-sentence {
            font-size: 5rem;
            font-weight: 900;
            line-height: 1.2;
            display: block;
        }

        /* 每個字的獨立容器 */
        .char-box {
            display: inline-block;
            position: relative;
            padding: 0 5px;
        }

        /* 顯示在每個字下方的亮度小數字 */
        .luma-val {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: normal;
            color: #0f0;
            background: rgba(0,0,0,0.6);
            padding: 1px 3px;
            border-radius: 3px;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="bg-container"></div>

    <div class="content">
        <div class="adaptive-sentence" id="target">這是一段逐字偵測亮度的測試文字，每個字都會獨立判斷黑白。</div>
    </div>

    <script>
        const target = document.getElementById('target');
        const img = new Image();
        
        // 解決 CORS 關鍵：如果是本地圖片請改回 'wb-background1.jpg'
        // 如果是遠端圖片必須設定 Anonymous
        img.crossOrigin = "Anonymous"; 
        img.src = 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=1600';

        // 1. 將文字拆解成單個字
        const text = target.innerText;
        target.innerHTML = '';
        const charElements = text.split('').map(char => {
            const span = document.createElement('span');
            span.className = 'char-box';
            span.innerText = char;
            target.appendChild(span);
            return span;
        });

        img.onload = () => {
            console.log("圖片載入完成，開始逐字掃描...");
            runAnalysis();
        };

        window.addEventListener('resize', runAnalysis);

        function runAnalysis() {
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const iw = img.width;
            const ih = img.height;

            const scale = Math.max(vw / iw, vh / ih);
            const dx = (vw - iw * scale) / 2;
            const dy = (vh - ih * scale) / 2;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            charElements.forEach(span => {
                const rect = span.getBoundingClientRect();
                
                // 設定 Canvas 大小（針對單個字）
                canvas.width = rect.width;
                canvas.height = rect.height;

                // 座標轉換
                const sx = (rect.left - dx) / scale;
                const sy = (rect.top - dy) / scale;
                const sw = rect.width / scale;
                const sh = rect.height / scale;

                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, rect.width, rect.height);

                try {
                    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                    let bSum = 0;
                    for (let i = 0; i < data.length; i += 16) {
                        bSum += (0.2126 * data[i] + 0.7152 * data[i+1] + 0.0722 * data[i+2]);
                    }
                    const luma = bSum / (data.length / 16);

                    // 套用顏色：亮背景用黑字，暗背景用白字
                    const isDark = luma < 128;
                    span.style.color = isDark ? 'white' : 'black';

                    // 更新下方的小數字
                    let label = span.querySelector('.luma-val');
                    if (!label) {
                        label = document.createElement('i');
                        label.className = 'luma-val';
                        span.appendChild(label);
                    }
                    label.innerText = Math.round(luma);
                } catch (e) {
                    console.error("CORS Error: 無法讀取像素。請確保圖片允許跨域或使用伺服器開啟。");
                }
            });
        }
    </script>
</body>
</html>